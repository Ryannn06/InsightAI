{% extends "base.html" %} {% block title %}Insight-4o{% endblock %} {% set
show_navbar = true %} {% block content %}
<div class="block-content-report">
    <div class="row gx-5">
        <div class="col-md-4 mb-5">
            {% include "components/card/overview.html" %}
        </div>
        <div class="col-md-8">
            {% include "components/card/reportcard.html" %}
        </div>
    </div>
</div>

{% block script%}

<script>
    $(document).ready(function () {
        $('#myTable').DataTable({
            paging: true,        // Enable pagination
            searching: true,     // Enable search box
            ordering: true,      // Enable column sorting
            info: true,          // Show "Showing x of y entries"
            lengthChange: true,
            scrollX: true        // Allow changing number of rows shown
        });
    });
</script>
<script type="text/javascript">
    // 1. Ensure both 'corechart' and 'table' packages are loaded
    google.charts.load('current', { 'packages': ['corechart', 'table'] });
    google.charts.setOnLoadCallback(drawAllCharts);

    const datasets = {{ openai_response | tojson | safe }};

    function drawAllCharts() {
        datasets.forEach((item, index) => {
            const container = document.getElementById('chart_' + index);
            if (!container || !item.result || item.result.length === 0) return;

            const resultRows = item.result;
            const dataTable = new google.visualization.DataTable();

            // 2. SMART COLUMN DETECTION
            const allKeys = Object.keys(resultRows[0]);
            let labelCol = "";
            let valueCols = [];

            allKeys.forEach(key => {
                const sampleValue = resultRows[0][key];
                if (typeof sampleValue === 'string' || isNaN(parseFloat(sampleValue))) {
                    labelCol = key;
                } else {
                    valueCols.push(key);
                }
            });

            if (!labelCol) labelCol = allKeys[0];

            dataTable.addColumn('string', labelCol);
            valueCols.forEach(col => dataTable.addColumn('number', col));

            // 3. ADD ROWS
            resultRows.forEach(row => {
                const rowValues = [];
                rowValues.push(String(row[labelCol]));
                valueCols.forEach(col => {
                    let val = parseFloat(row[col]);
                    rowValues.push(isNaN(val) ? 0 : val);
                });
                dataTable.addRow(rowValues);
            });

            // 4. SEPARATE OPTIONS
            const type = (item.chart_type || 'bar').toLowerCase();

            if (type === 'table') {
                // Table-specific options
                const tableOptions = {
                    showRowNumber: true,
                    width: '100%',
                    height: '100%',            // Changed from 100% to auto for better pagination flow
                    alternatingRowStyle: true,
                    
                    // --- PAGINATION UPDATES ---
                    page: 'enable',            // Enables the next/prev buttons
                    pageSize: 10,              // Number of rows per page
                    pagingButtons: 'both',     // Shows both 'Next' and 'Prev' buttons
                    
                    // Optional styling to make it look cleaner
                    cssClassNames: {
                        headerRow: 'header-row',
                        tableRow: 'table-row',
                        oddTableRow: 'odd-table-row',
                        selectedTableRow: 'selected-table-row',
                        hoverTableRow: 'hover-table-row',
                        headerCell: 'header-cell',
                        tableCell: 'table-cell',
                        rowNumberCell: 'row-number-cell'
                    }
                };
                const chart = new google.visualization.Table(container);
                chart.draw(dataTable, tableOptions);
            } 

            else if (type === 'heatmap') {
                const table = new google.visualization.Table(container);

                // Create color gradient (White to Purple)
                var formatter = new google.visualization.ColorFormat();
                formatter.addGradientRange(null, null, 'black', '#FFFFFF', '#6F42C1');

                // Apply to all numeric columns
                for (let i = 1; i <= valueCols.length; i++) {
                    formatter.format(dataTable, i);
                }

                table.draw(dataTable, {
                    allowHtml: true,
                    width: '100%',
                    alternatingRowStyle: false
                });
            }
            
            else {
                // Core chart options (Bar, Line, Pie)
                // Core chart options (Bar, Line, Pie)
                const coreOptions = {
                    backgroundColor: 'transparent',
                    titleTextStyle: { color: '#FFFFFF', fontName: 'Inter', fontSize: 16 },
                    
                    // --- DARK MODE UPDATES ---
                    legend: { 
                        position: 'bottom', 
                        textStyle: { color: '#FFFFFF' } 
                    },
                    hAxis: { 
                        slantedText: true, 
                        slantedTextAngle: 45,
                        textStyle: { color: '#FFFFFF' },      // Labels color
                        gridlines: { color: '#333333' },      // Dark gridlines
                        baselineColor: '#555555'             // Bottom axis line
                    },
                    vAxis: { 
                        minValue: 0, 
                        format: 'short',
                        textStyle: { color: '#FFFFFF' },      // Labels color
                        gridlines: { color: '#333333' },      // Side gridlines
                        baselineColor: '#555555'             // Left axis line
                    },
                    // -------------------------

                    colors: ['#6F42C1', '#007BFF', '#28A745'],
                    height: 350,
                    width: '100%',
                    chartArea: {
                        left: '15%',
                        right: '5%',
                        top: 20,
                        bottom: 60,
                        width: '80%',
                        height: '70%'
                    }
                };

                let chart;
                if (type === 'line') {
                    chart = new google.visualization.LineChart(container);
                } else if (type === 'pie') {
                    chart = new google.visualization.PieChart(container);
                } else {
                    chart = new google.visualization.ColumnChart(container);
                }
                chart.draw(dataTable, coreOptions);
            }
        });
    }

    window.addEventListener('resize', () => {
        clearTimeout(window.resizer);
        window.resizer = setTimeout(drawAllCharts, 250);
    });
</script>
{% endblock %} {% endblock %}
